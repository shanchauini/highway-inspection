# é£è¡Œå·¡æ£€ç³»ç»Ÿ Bugä¿®å¤è¡¥ä¸æ–‡æ¡£

**æ—¥æœŸ**: 2025å¹´11æœˆ15æ—¥  
**ç‰ˆæœ¬**: v1.0.5  
**æ›´æ–°æ—¶é—´**: 2025-11-15 18:41 UTC+8

---

## é—®é¢˜æ¦‚è¿°

åœ¨ç³»ç»Ÿæµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸**æ—¶é—´å¤„ç†ã€ä»»åŠ¡ç®¡ç†ã€ä¸šåŠ¡é€»è¾‘éªŒè¯å’Œå‰ç«¯æ˜¾ç¤º**ç›¸å…³çš„å¤šä¸ªé—®é¢˜ï¼Œè¿™äº›é—®é¢˜å¯¼è‡´ï¼š
- é£è¡Œç”³è¯·å®¡æ‰¹åæ— æ³•åœ¨è§„å®šæ—¶é—´å†…æ”¾é£
- æ•°æ®åº“å­˜å‚¨çš„æ—¶é—´ä¸å®é™…åˆ›å»ºæ—¶é—´ä¸ä¸€è‡´ï¼ˆç›¸å·®8å°æ—¶ï¼‰
- å‰ç«¯åœ°å›¾é¡µé¢æ˜¾ç¤ºUTCæ—¶é—´è€Œéæœ¬åœ°æ—¶é—´
- é£è¡Œä»»åŠ¡æ‰§è¡Œç»“æŸåä¸ä¼šè‡ªåŠ¨ç»“æŸï¼ŒæŒç»­æ˜¾ç¤º"æ‰§è¡Œä¸­"çŠ¶æ€
- **ç”¨æˆ·å¯å¡«å†™è¶…å‡ºæ—¶é—´çª—å£çš„é£è¡Œæ—¶é•¿**ï¼ˆğŸ†•ï¼‰
- **æ”¾é£æ—¶æœªéªŒè¯é¢„è®¡ç»“æŸæ—¶é—´ï¼Œå¯èƒ½å¯¼è‡´ä»»åŠ¡æ— æ³•åœ¨è®¡åˆ’æ—¶é—´å†…å®Œæˆ**ï¼ˆğŸ†•ï¼‰

---

## æ ¸å¿ƒé—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

Pythonçš„ `datetime.utcnow()` åœ¨æŸäº›ç¯å¢ƒä¸‹**è¿”å›æœ¬åœ°æ—¶é—´è€ŒéçœŸæ­£çš„UTCæ—¶é—´**ï¼Œå¯¼è‡´ï¼š
1. æ—¶é—´æ¯”è¾ƒé€»è¾‘é”™è¯¯ï¼ˆæœ¬åœ°æ—¶é—´ä¸UTCæ—¶é—´æ¯”è¾ƒï¼‰
2. æ•°æ®åº“å­˜å‚¨æ—¶é—´åå·®
3. å‰ç«¯æ—¶é—´è½¬æ¢å¤±è´¥

### æ—¶åŒºæ¶æ„è®¾è®¡ï¼ˆæœ€ä½³å®è·µï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     UTCè½¬æ¢      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     UTCå­˜å‚¨     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ç•Œé¢   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   åç«¯API    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   MySQL DB   â”‚
â”‚  (æœ¬åœ°æ—¶é—´)  â”‚                  â”‚  (UTCå¤„ç†)   â”‚                 â”‚   (UTCæ—¶é—´)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     æœ¬åœ°æ˜¾ç¤º     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     UTCè¿”å›     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–²                                                                    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ dayjs.utc().local() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é—®é¢˜æ¸…å•åŠä¿®å¤æ–¹æ¡ˆ

### é—®é¢˜1: é£è¡Œç”³è¯·æ— æ³•åœ¨è§„å®šæ—¶é—´å†…æ”¾é£ 

**ç°è±¡**ï¼š
```
åˆ›å»ºæ—¶é—´: 2025-11-15 17:09 (åŒ—äº¬æ—¶é—´)
æ•°æ®åº“æ—¶é—´: 2025-11-15 09:09 (UTCï¼Œæ­£ç¡®)
æ”¾é£æ—¶é—´: 2025-11-15 17:10 (åŒ—äº¬æ—¶é—´)

é”™è¯¯åˆ¤æ–­: now(17:10 æœ¬åœ°) > planned_end_time(09:09 UTC) â†’ è¶…æ—¶æ‹’ç» âŒ
æ­£ç¡®åˆ¤æ–­: now(09:10 UTC) < planned_end_time(09:14 UTC) â†’ å…è®¸æ”¾é£ âœ…
```

**æ ¹æœ¬åŸå› **ï¼š`datetime.utcnow()` è¿”å›æœ¬åœ°æ—¶é—´

**ä¿®å¤ä½ç½®**ï¼š`highway-inspection-backend/app/services/flight_service.py`

```python
# âŒ ä¿®å¤å‰ (ç¬¬188è¡Œ)
now = datetime.utcnow()

# âœ… ä¿®å¤å
now = datetime.now(timezone.utc).replace(tzinfo=None)
```

**å®Œæ•´ä»£ç ä¿®æ”¹**ï¼š
```python
# ç¬¬186-199è¡Œ
# æ£€æŸ¥æ—¶é—´æ˜¯å¦åœ¨ç”³è¯·èŒƒå›´å†…
# ä½¿ç”¨timezone-awareçš„UTCæ—¶é—´ï¼Œç¡®ä¿æ­£ç¡®æ€§
now = datetime.now(timezone.utc).replace(tzinfo=None)
print(f"[DEBUG] æ”¾é£æ—¶é—´æ£€æŸ¥:")
print(f"  å½“å‰UTCæ—¶é—´: {now}")
print(f"  ç”³è¯·å¼€å§‹æ—¶é—´: {application.planned_start_time} (ç±»å‹: {type(application.planned_start_time)})")
print(f"  ç”³è¯·ç»“æŸæ—¶é—´: {application.planned_end_time} (ç±»å‹: {type(application.planned_end_time)})")
print(f"  now < start: {now < application.planned_start_time}")
print(f"  now > end: {now > application.planned_end_time}")

if now < application.planned_start_time or now > application.planned_end_time:
    error_msg = f'å½“å‰æ—¶é—´ä¸åœ¨ç”³è¯·çš„é£è¡Œæ—¶é—´èŒƒå›´å†… (å½“å‰UTC: {now}, ç”³è¯·æ—¶é—´: {application.planned_start_time} ~ {application.planned_end_time})'
    print(f"[ERROR] {error_msg}")
    raise ValueError(error_msg)
```

---

### é—®é¢˜2: å‰ç«¯æ”¾é£æ—¶é—´æ£€æŸ¥é€»è¾‘é”™è¯¯ 

**ç°è±¡**ï¼šå‰ç«¯åœ¨å‘é€è¯·æ±‚å‰å°±æ‹¦æˆªäº†åˆæ³•çš„æ”¾é£æ“ä½œ

**æ ¹æœ¬åŸå› **ï¼šå‰ç«¯æ—¶é—´æ¯”è¾ƒæœªè½¬æ¢æ—¶åŒº

**ä¿®å¤ä½ç½®**ï¼š`highway-inspection-frontend/src/views/Flights.vue`

```javascript
// âŒ ä¿®å¤å‰ (ç¬¬531-533è¡Œ)
const now = dayjs()
const startTime = dayjs(app.planned_start_time)  // æŠŠUTCå½“æœ¬åœ°è§£æ
const endTime = dayjs(app.planned_end_time)

// âœ… ä¿®å¤å
const now = dayjs()
const startTime = dayjs.utc(app.planned_start_time).local()  // UTCè½¬æœ¬åœ°
const endTime = dayjs.utc(app.planned_end_time).local()
```

**å®Œæ•´ä»£ç ä¿®æ”¹**ï¼š
```javascript
// ç¬¬528-543è¡Œ
const requestLaunch = async (app: FlightApplication) => {
  try {
    // æ£€æŸ¥æ—¶é—´æ˜¯å¦åœ¨ç”³è¯·èŒƒå›´å†…ï¼ˆæ‰€æœ‰æ—¶é—´è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´æ¯”è¾ƒï¼‰
    const now = dayjs()
    const startTime = dayjs.utc(app.planned_start_time).local()
    const endTime = dayjs.utc(app.planned_end_time).local()
    
    if (now.isBefore(startTime)) {
      ElMessage.warning(`æ”¾é£æ—¶é—´æœªåˆ°ï¼Œç”³è¯·çš„å¼€å§‹æ—¶é—´ä¸ºï¼š${formatDateTime(app.planned_start_time)}`)
      return
    }
    
    if (now.isAfter(endTime)) {
      ElMessage.warning(`æ”¾é£æ—¶é—´å·²è¿‡ï¼Œç”³è¯·çš„ç»“æŸæ—¶é—´ä¸ºï¼š${formatDateTime(app.planned_end_time)}`)
      return
    }
    // ... åç»­ä»£ç 
```

---

### é—®é¢˜3: åœ°å›¾é¡µé¢ä»»åŠ¡æ—¶é—´æ˜¾ç¤ºä¸ºUTC 

**ç°è±¡**ï¼šåœ°å›¾æ€»è§ˆä¸­æ˜¾ç¤º `2025/11/15 09:28:53` (UTC) è€Œé `2025/11/15 17:28:53` (æœ¬åœ°)

**æ ¹æœ¬åŸå› **ï¼šæ—¶é—´æ ¼å¼åŒ–æœªè½¬æ¢æ—¶åŒº

**ä¿®å¤ä½ç½®**ï¼š`highway-inspection-frontend/src/views/Map.vue`

```javascript
// âŒ ä¿®å¤å‰ (ç¬¬108-111è¡Œ)
const formatTime = (t?: string | null) => {
  if (!t) return '-'
  return new Date(t).toLocaleString()
}

// âœ… ä¿®å¤å
import dayjs from 'dayjs'
import utc from 'dayjs/plugin/utc'
dayjs.extend(utc)

const formatTime = (t?: string | null) => {
  if (!t) return '-'
  // UTCæ—¶é—´è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´æ˜¾ç¤º
  return dayjs.utc(t).local().format('YYYY/MM/DD HH:mm:ss')
}
```

---

### é—®é¢˜4: é£è¡Œä»»åŠ¡ä¸ä¼šè‡ªåŠ¨ç»“æŸ 

**ç°è±¡**ï¼š
- ä»»åŠ¡è®¡åˆ’é£è¡Œ3åˆ†é’Ÿï¼Œä½†10åˆ†é’Ÿåä»æ˜¾ç¤º"æ‰§è¡Œä¸­"
- ç©ºåŸŸæŒç»­è¢«å ç”¨ï¼Œæ— æ³•åˆ›å»ºæ–°ä»»åŠ¡

**æ ¹æœ¬åŸå› **ï¼š
1. åˆ›å»ºä»»åŠ¡æ—¶æœªè®¾ç½® `end_time`
2. æ— è‡ªåŠ¨æ£€æŸ¥ä»»åŠ¡è¶…æ—¶çš„æœºåˆ¶

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

#### A. åˆ›å»ºä»»åŠ¡æ—¶è®¾ç½®ç»“æŸæ—¶é—´

**ä¿®å¤ä½ç½®**ï¼š`highway-inspection-backend/app/services/flight_service.py`

```python
# âŒ ä¿®å¤å‰ (ç¬¬213-220è¡Œ)
mission = Mission(
    flight_application_id=application.id,
    operator_id=user_id,
    route=application.route,
    start_time=now,
    #end_time=start_time+application.total_time,è¿™é‡Œç›´æ¥è®¡ç®—é£è¡Œä»»åŠ¡ç»“æŸæ—¶é—´
    status='executing'
)

# âœ… ä¿®å¤å
# åˆ›å»ºä»»åŠ¡ï¼Œè®¡ç®—é¢„è®¡ç»“æŸæ—¶é—´
estimated_end_time = now + timedelta(minutes=application.total_time)
mission = Mission(
    flight_application_id=application.id,
    operator_id=user_id,
    route=application.route,
    start_time=now,
    end_time=estimated_end_time,  # è®¾ç½®é¢„è®¡ç»“æŸæ—¶é—´
    status='executing'
)

print(f"[DEBUG] åˆ›å»ºä»»åŠ¡:")
print(f"  start_time: {now}")
print(f"  total_time: {application.total_time}åˆ†é’Ÿ")
print(f"  estimated_end_time: {estimated_end_time}")
```

#### B. è·å–æ´»è·ƒä»»åŠ¡æ—¶è‡ªåŠ¨ç»“æŸè¶…æ—¶ä»»åŠ¡

**ä¿®å¤ä½ç½®**ï¼š`highway-inspection-backend/app/routes/missions.py`

```python
# ä¿®å¤å (ç¬¬67-111è¡Œ)
@missions_bp.route('/active', methods=['GET'])
@login_required
def get_active_missions():
    """è·å–è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼ˆç”¨äºåœ°å›¾æ˜¾ç¤ºï¼‰"""
    try:
        from datetime import datetime, timezone
        from app.models import db, Airspace
        
        user_id = get_jwt_identity()
        user = User.query.get(int(user_id))

        query = Mission.query.filter_by(status='executing')

        # æ“ä½œå‘˜åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä»»åŠ¡
        if not user.is_admin():
            query = query.filter_by(operator_id=user_id)

        missions = query.all()
        
        # æ£€æŸ¥å¹¶è‡ªåŠ¨ç»“æŸè¶…æ—¶çš„ä»»åŠ¡
        now = datetime.now(timezone.utc).replace(tzinfo=None)
        completed_count = 0
        for mission in missions[:]:  # ä½¿ç”¨åˆ‡ç‰‡åˆ›å»ºå‰¯æœ¬éå†
            if mission.end_time and now >= mission.end_time:
                print(f"[INFO] è‡ªåŠ¨ç»“æŸè¶…æ—¶ä»»åŠ¡ #{mission.id}: è®¡åˆ’ç»“æŸæ—¶é—´ {mission.end_time}, å½“å‰æ—¶é—´ {now}")
                mission.status = 'completed'
                # é‡Šæ”¾ç©ºåŸŸ
                if mission.flight_application:
                    airspace = Airspace.query.get(mission.flight_application.planned_airspace_id)
                    if airspace and airspace.status == 'occupied':
                        airspace.status = 'available'
                        print(f"[INFO] é‡Šæ”¾ç©ºåŸŸ #{airspace.id}")
                missions.remove(mission)  # ä»åˆ—è¡¨ç§»é™¤
                completed_count += 1
        
        if completed_count > 0:
            db.session.commit()
            print(f"[INFO] è‡ªåŠ¨ç»“æŸäº† {completed_count} ä¸ªè¶…æ—¶ä»»åŠ¡")

        return success_response(
            data=[mission.to_dict(include_relations=True) for mission in missions]
        )

    except Exception as e:
        return error_response(f'è·å–æ´»è·ƒä»»åŠ¡å¤±è´¥: {str(e)}', 500)
```

---

### é—®é¢˜5: æ•°æ®æ¨¡å‹é»˜è®¤æ—¶é—´å‡½æ•°é—®é¢˜ 

**ä¿®å¤ä½ç½®**ï¼š`highway-inspection-backend/app/models/mission.py`

```python
# âŒ ä¿®å¤å‰ (ç¬¬1, 18-19è¡Œ)
from datetime import datetime

class Mission(db.Model):
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

# âœ… ä¿®å¤å
from datetime import datetime, timezone

def utcnow():
    """è¿”å›çœŸæ­£çš„UTCæ—¶é—´ï¼ˆæ— æ—¶åŒºï¼‰"""
    return datetime.now(timezone.utc).replace(tzinfo=None)

class Mission(db.Model):
    created_at = db.Column(db.DateTime, default=utcnow)
    updated_at = db.Column(db.DateTime, default=utcnow, onupdate=utcnow)
```

---

### é—®é¢˜6: å…¶ä»–æœåŠ¡ä¸­çš„UTCæ—¶é—´è·å– 

#### ä¿®å¤ä½ç½®1ï¼š`app/services/flight_service.py`

```python
# ç¬¬263-265è¡Œ
@staticmethod
def check_expired_applications():
    """æ£€æŸ¥å¹¶æ›´æ–°è¿‡æœŸçš„ç”³è¯·"""
    now = datetime.now(timezone.utc).replace(tzinfo=None)  # ä¿®å¤
    expired_apps = FlightApplication.query.filter(
        FlightApplication.status == 'pending',
        FlightApplication.planned_end_time < now
    ).all()
```

#### ä¿®å¤ä½ç½®2ï¼š`app/services/dashboard_service.py`

```python
# ç¬¬1è¡Œæ·»åŠ å¯¼å…¥
from datetime import datetime, timedelta, timezone

# ç¬¬128-130è¡Œ
@staticmethod
def get_alert_trend(days=7):
    """è·å–å‘Šè­¦è¶‹åŠ¿ï¼ˆæœ€è¿‘Nå¤©ï¼‰"""
    end_date = datetime.now(timezone.utc).replace(tzinfo=None)  # ä¿®å¤
    start_date = end_date - timedelta(days=days)
```

#### ä¿®å¤ä½ç½®3ï¼š`app/routes/missions.py`

```python
# ç¬¬116-136è¡Œ - complete_missionå‡½æ•°
from datetime import datetime, timezone

# æ›´æ–°ä»»åŠ¡çŠ¶æ€
mission.status = 'completed'
mission.end_time = datetime.now(timezone.utc).replace(tzinfo=None)  # ä¿®å¤
```

---

### é—®é¢˜7: é£è¡Œç”³è¯·ç¼ºä¹æ—¶é•¿éªŒè¯é€»è¾‘ ğŸ†•



**ç°è±¡**ï¼š
- ç”¨æˆ·å¯ä»¥å¡«å†™é£è¡Œæ—¶é•¿å¤§äºè®¡åˆ’æ—¶é—´çª—å£ï¼ˆå¦‚ï¼š10åˆ†é’Ÿçª—å£å†…ç”³è¯·15åˆ†é’Ÿé£è¡Œï¼‰
- å³ä½¿å½“å‰æ—¶é—´ + é£è¡Œæ—¶é•¿è¶…å‡ºè®¡åˆ’ç»“æŸæ—¶é—´ï¼Œç³»ç»Ÿä»å…è®¸æ”¾é£
- å¯èƒ½å¯¼è‡´ä»»åŠ¡æ— æ³•åœ¨è®¡åˆ’æ—¶é—´å†…å®Œæˆï¼Œå½±å“ç©ºåŸŸç®¡ç†

**æ ¹æœ¬åŸå› **ï¼š
- åç«¯ `create_application` å’Œ `update_application` ç¼ºä¹æ—¶é•¿éªŒè¯
- åç«¯ `launch_flight` æœªæ£€æŸ¥é¢„è®¡ç»“æŸæ—¶é—´æ˜¯å¦è¶…å‡ºè®¡åˆ’
- å‰ç«¯è¡¨å•éªŒè¯æœªå®æ—¶éªŒè¯æ—¶é•¿ä¸æ—¶é—´çª—å£å…³ç³»
- å‰ç«¯æ”¾é£æ“ä½œæœªè®¡ç®—é¢„è®¡ç»“æŸæ—¶é—´

---

#### ä¿®å¤æ–¹æ¡ˆ7.1: åç«¯åˆ›å»º/æ›´æ–°ç”³è¯·æ—¶éªŒè¯æ—¶é•¿

**æ–‡ä»¶**: `app/services/flight_service.py`

**ä½ç½®1**: `create_application` æ–¹æ³•ï¼ˆç¬¬43-53è¡Œï¼‰

```python
# æ·»åŠ éªŒè¯é€»è¾‘
FlightService._normalize_time_fields(kwargs)

# éªŒè¯é£è¡Œæ—¶é•¿
if 'planned_start_time' in kwargs and 'planned_end_time' in kwargs and 'total_time' in kwargs:
    start_time = kwargs['planned_start_time']
    end_time = kwargs['planned_end_time']
    total_time = kwargs['total_time']
    
    # è®¡ç®—æ—¶é—´çª—å£ï¼ˆåˆ†é’Ÿï¼‰
    time_window = (end_time - start_time).total_seconds() / 60
    
    if total_time > time_window:
        raise ValueError(f'é£è¡Œæ—¶é•¿ï¼ˆ{total_time}åˆ†é’Ÿï¼‰ä¸èƒ½è¶…è¿‡è®¡åˆ’æ—¶é—´çª—å£ï¼ˆ{int(time_window)}åˆ†é’Ÿï¼‰')

application = FlightApplication(
    user_id=user_id,
    status='draft',
    **kwargs
)
```

**ä½ç½®2**: `update_application` æ–¹æ³•ï¼ˆç¬¬86-94è¡Œï¼‰

```python
FlightService._normalize_time_fields(kwargs)

# éªŒè¯é£è¡Œæ—¶é•¿ï¼ˆè€ƒè™‘æ›´æ–°å’ŒåŸæœ‰å€¼ï¼‰
start_time = kwargs.get('planned_start_time', application.planned_start_time)
end_time = kwargs.get('planned_end_time', application.planned_end_time)
total_time = kwargs.get('total_time', application.total_time)

if start_time and end_time and total_time:
    time_window = (end_time - start_time).total_seconds() / 60
    if total_time > time_window:
        raise ValueError(f'é£è¡Œæ—¶é•¿ï¼ˆ{total_time}åˆ†é’Ÿï¼‰ä¸èƒ½è¶…è¿‡è®¡åˆ’æ—¶é—´çª—å£ï¼ˆ{int(time_window)}åˆ†é’Ÿï¼‰')

for key, value in kwargs.items():
    if hasattr(application, key):
        setattr(application, key, value)
```

---

#### ä¿®å¤æ–¹æ¡ˆ7.2: åç«¯æ”¾é£æ—¶éªŒè¯é¢„è®¡ç»“æŸæ—¶é—´

**æ–‡ä»¶**: `app/services/flight_service.py`

**ä½ç½®**: `launch_flight` æ–¹æ³•ï¼ˆç¬¬223-239è¡Œï¼‰

```python
# ç°æœ‰çš„æ—¶é—´èŒƒå›´æ£€æŸ¥ä¹‹åæ·»åŠ 
if now < application.planned_start_time or now > application.planned_end_time:
    error_msg = f'å½“å‰æ—¶é—´ä¸åœ¨ç”³è¯·çš„é£è¡Œæ—¶é—´èŒƒå›´å†…...'
    raise ValueError(error_msg)

# æ–°å¢ï¼šéªŒè¯é¢„è®¡ç»“æŸæ—¶é—´
estimated_finish_time = now + timedelta(minutes=application.total_time)

print(f"[DEBUG] é¢„è®¡ç»“æŸæ—¶é—´æ£€æŸ¥:")
print(f"  é£è¡Œæ—¶é•¿: {application.total_time}åˆ†é’Ÿ")
print(f"  é¢„è®¡ç»“æŸæ—¶é—´: {estimated_finish_time}")
print(f"  è®¡åˆ’ç»“æŸæ—¶é—´: {application.planned_end_time}")

if estimated_finish_time > application.planned_end_time:
    time_shortage = (estimated_finish_time - application.planned_end_time).total_seconds() / 60
    error_msg = (
        f'é¢„è®¡ç»“æŸæ—¶é—´ï¼ˆ{estimated_finish_time.strftime("%H:%M:%S")}ï¼‰'
        f'è¶…å‡ºè®¡åˆ’ç»“æŸæ—¶é—´ï¼ˆ{application.planned_end_time.strftime("%H:%M:%S")}ï¼‰çº¦{int(time_shortage)}åˆ†é’Ÿï¼Œ'
        f'æ— æ³•åœ¨è®¡åˆ’æ—¶é—´å†…å®Œæˆé£è¡Œä»»åŠ¡ï¼Œä¸å¾—æ”¾é£'
    )
    print(f"[ERROR] {error_msg}")
    raise ValueError(error_msg)
```

**ä¿®å¤è¯´æ˜**ï¼š
- è®¡ç®—é¢„è®¡ç»“æŸæ—¶é—´ = å½“å‰æ—¶é—´ + é£è¡Œæ—¶é•¿
- å¦‚æœé¢„è®¡ç»“æŸæ—¶é—´è¶…å‡ºè®¡åˆ’ç»“æŸæ—¶é—´ï¼Œæ‹’ç»æ”¾é£å¹¶è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
- æ·»åŠ DEBUGæ—¥å¿—ä¾¿äºæ’æŸ¥é—®é¢˜

---

#### ä¿®å¤æ–¹æ¡ˆ7.3: å‰ç«¯è¡¨å•å®æ—¶éªŒè¯

**æ–‡ä»¶**: `highway-inspection-frontend/src/views/Flights.vue`

**ä½ç½®1**: æ·»åŠ å¯¼å…¥å’Œrefå®šä¹‰ï¼ˆç¬¬254ã€278è¡Œï¼‰

```typescript
// æ·»åŠ watchå¯¼å…¥
import { ref, computed, onMounted, watch } from 'vue'

// æ·»åŠ è¡¨å•å¼•ç”¨
const applicationFormRef = ref<any>(null)
```

**ä½ç½®2**: æ·»åŠ éªŒè¯å‡½æ•°ï¼ˆç¬¬306-332è¡Œï¼‰

```typescript
// é£è¡Œæ—¶é•¿éªŒè¯å‡½æ•°
const validateFlightDuration = (rule: any, value: number, callback: any) => {
  if (!value) {
    return callback(new Error('è¯·è¾“å…¥é£è¡Œæ—¶é•¿'))
  }
  
  if (value < 1) {
    return callback(new Error('é£è¡Œæ—¶é•¿è‡³å°‘ä¸º1åˆ†é’Ÿ'))
  }
  
  const startTime = applicationForm.value.planned_start_time
  const endTime = applicationForm.value.planned_end_time
  
  if (startTime && endTime) {
    const timeWindowMinutes = dayjs(endTime).diff(dayjs(startTime), 'minute')
    
    if (timeWindowMinutes <= 0) {
      return callback(new Error('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´'))
    }
    
    if (value > timeWindowMinutes) {
      return callback(new Error(`é£è¡Œæ—¶é•¿ä¸èƒ½è¶…è¿‡æ—¶é—´çª—å£ï¼ˆ${timeWindowMinutes}åˆ†é’Ÿï¼‰`))
    }
  }
  
  callback()
}
```

**ä½ç½®3**: ä¿®æ”¹éªŒè¯è§„åˆ™ï¼ˆç¬¬341-344è¡Œï¼‰

```typescript
const applicationRules = {
  // ... å…¶ä»–è§„åˆ™ ...
  total_time: [
    { required: true, message: 'è¯·è¾“å…¥è®¡åˆ’æ—¶é•¿', trigger: 'blur' },
    { validator: validateFlightDuration, trigger: 'blur' }
  ]
}
```

**ä½ç½®4**: æ·»åŠ æ—¶é—´å˜åŒ–ç›‘å¬ï¼ˆç¬¬347-356è¡Œï¼‰

```typescript
// ç›‘å¬æ—¶é—´å˜åŒ–ï¼Œè§¦å‘æ—¶é•¿éªŒè¯
watch([
  () => applicationForm.value.planned_start_time,
  () => applicationForm.value.planned_end_time
], () => {
  // å¦‚æœå·²ç»å¡«å†™äº†æ—¶é•¿ï¼Œé‡æ–°éªŒè¯
  if (applicationForm.value.total_time && applicationFormRef.value) {
    applicationFormRef.value.validateField('total_time')
  }
})
```

**ä¿®å¤è¯´æ˜**ï¼š
- ç”¨æˆ·å¡«å†™æ—¶é•¿æ—¶å®æ—¶éªŒè¯æ˜¯å¦è¶…è¿‡æ—¶é—´çª—å£
- ç”¨æˆ·ä¿®æ”¹å¼€å§‹/ç»“æŸæ—¶é—´æ—¶ï¼Œè‡ªåŠ¨é‡æ–°éªŒè¯æ—¶é•¿
- æä¾›å‹å¥½çš„é”™è¯¯æç¤ºä¿¡æ¯

---

#### ä¿®å¤æ–¹æ¡ˆ7.4: å‰ç«¯æ”¾é£å‰éªŒè¯

**æ–‡ä»¶**: `highway-inspection-frontend/src/views/Flights.vue`

**ä½ç½®**: `requestLaunch` æ–¹æ³•ï¼ˆç¬¬588-602è¡Œï¼‰

```typescript
// ç°æœ‰æ—¶é—´èŒƒå›´æ£€æŸ¥ä¹‹åæ·»åŠ 
if (now.isAfter(endTime)) {
  ElMessage.warning(`æ”¾é£æ—¶é—´å·²è¿‡ï¼Œç”³è¯·çš„ç»“æŸæ—¶é—´ä¸ºï¼š${formatDateTime(app.planned_end_time)}`)
  return
}

// æ–°å¢ï¼šéªŒè¯é¢„è®¡ç»“æŸæ—¶é—´
const estimatedFinishTime = now.add(app.total_time, 'minute')

if (estimatedFinishTime.isAfter(endTime)) {
  const timeShortage = estimatedFinishTime.diff(endTime, 'minute')
  ElMessage.error({
    message: `é¢„è®¡ç»“æŸæ—¶é—´ï¼ˆ${estimatedFinishTime.format('HH:mm:ss')}ï¼‰è¶…å‡ºè®¡åˆ’ç»“æŸæ—¶é—´ï¼ˆ${endTime.format('HH:mm:ss')}ï¼‰çº¦${timeShortage}åˆ†é’Ÿï¼Œæ— æ³•å®Œæˆé£è¡Œä»»åŠ¡ï¼Œä¸å¾—æ”¾é£ï¼`,
    duration: 5000,
    showClose: true
  })
  return
}

// åœ¨ç¡®è®¤å¯¹è¯æ¡†ä¸­æ˜¾ç¤ºé¢„è®¡ç»“æŸæ—¶é—´
await ElMessageBox.confirm(
  `ç¡®è®¤ç”³è¯·æ”¾é£ï¼Ÿ\nç”³è¯·æ—¶é—´ï¼š${formatDateTime(app.planned_start_time)} è‡³ ${formatDateTime(app.planned_end_time)}\nå½“å‰æ—¶é—´ï¼š${formatDateTime(now.format())}\né¢„è®¡ç»“æŸï¼š${estimatedFinishTime.format('YYYY-MM-DD HH:mm:ss')}`,
  'ç¡®è®¤æ”¾é£',
  // ...
)
```

**ä¿®å¤è¯´æ˜**ï¼š
- è®¡ç®—é¢„è®¡ç»“æŸæ—¶é—´å¹¶ä¸è®¡åˆ’ç»“æŸæ—¶é—´æ¯”å¯¹
- å¦‚æœè¶…å‡ºåˆ™æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆåŒ…æ‹¬è¶…å‡ºåˆ†é’Ÿæ•°ï¼‰
- åœ¨ç¡®è®¤å¯¹è¯æ¡†ä¸­æ˜¾ç¤ºé¢„è®¡ç»“æŸæ—¶é—´ï¼Œæ–¹ä¾¿ç”¨æˆ·å†³ç­–

---

#### éªŒè¯æµç¨‹

```
ç”¨æˆ·åˆ›å»º/ç¼–è¾‘ç”³è¯·
    â†“
ã€å‰ç«¯å®æ—¶éªŒè¯ã€‘total_time <= (end_time - start_time)
    â†“ æäº¤
ã€åç«¯åˆ›å»º/æ›´æ–°éªŒè¯ã€‘total_time <= (end_time - start_time)
    â†“ éªŒè¯é€šè¿‡
ä¿å­˜åˆ°æ•°æ®åº“
    â†“
ç®¡ç†å‘˜å®¡æ‰¹é€šè¿‡
    â†“
ç”¨æˆ·ç‚¹å‡»æ”¾é£
    â†“
ã€å‰ç«¯æ”¾é£å‰éªŒè¯ã€‘now + total_time <= end_time
    â†“ éªŒè¯é€šè¿‡
ã€åç«¯æ”¾é£éªŒè¯ã€‘now + total_time <= end_time
    â†“ éªŒè¯é€šè¿‡
åˆ›å»ºä»»åŠ¡æˆåŠŸ 
```


---

## ä¿®å¤æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | è¡Œå· | è¯´æ˜ |
|---------|---------|------|------|
| `backend/app/services/flight_service.py` | å·²ä¿®å¤ | 43-53, 86-94, 188, 213-227, 223-239, 265 | UTCæ—¶é—´è·å–ä¿®å¤ã€ä»»åŠ¡ç»“æŸæ—¶é—´è®¾ç½®ã€**æ—¶é•¿éªŒè¯**ã€**é¢„è®¡ç»“æŸæ—¶é—´éªŒè¯** |
| `backend/app/services/dashboard_service.py` | å·²ä¿®å¤ | 1, 130 | UTCæ—¶é—´è·å–ä¿®å¤ |
| `backend/app/routes/missions.py` | å·²ä¿®å¤ | 67-111, 136 | ä»»åŠ¡è‡ªåŠ¨ç»“æŸé€»è¾‘ã€UTCæ—¶é—´ä¿®å¤ |
| `backend/app/models/mission.py` | å·²ä¿®å¤ | 1, 7-9, 23-24 | æ¨¡å‹é»˜è®¤æ—¶é—´å‡½æ•°ä¿®å¤ |
| `frontend/src/views/Flights.vue` | å·²ä¿®å¤ | 254, 278, 306-356, 531-533, 588-602 | å‰ç«¯æ”¾é£æ—¶é—´æ£€æŸ¥é€»è¾‘ã€**è¡¨å•æ—¶é•¿éªŒè¯**ã€**é¢„è®¡ç»“æŸæ—¶é—´éªŒè¯** |
| `frontend/src/views/Map.vue` | å·²ä¿®å¤ | 99-102, 112-115 | åœ°å›¾æ—¶é—´æ˜¾ç¤ºæ ¼å¼åŒ– |

---


## åç»­ä¼˜åŒ–å»ºè®®

### 1. å®šæ—¶ä»»åŠ¡ä¼˜åŒ–
**å½“å‰æ–¹æ¡ˆ**ï¼šåœ¨è·å–æ´»è·ƒä»»åŠ¡æ—¶æ£€æŸ¥è¶…æ—¶ï¼ˆè¢«åŠ¨è§¦å‘ï¼‰  
**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼šæ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆCelery/APSchedulerï¼‰ï¼Œæ¯åˆ†é’Ÿä¸»åŠ¨æ£€æŸ¥

```python
# ç¤ºä¾‹ï¼šä½¿ç”¨APScheduler
from apscheduler.schedulers.background import BackgroundScheduler

def check_and_complete_expired_missions():
    """å®šæ—¶æ£€æŸ¥å¹¶å®Œæˆè¶…æ—¶ä»»åŠ¡"""
    now = datetime.now(timezone.utc).replace(tzinfo=None)
    expired_missions = Mission.query.filter(
        Mission.status == 'executing',
        Mission.end_time <= now
    ).all()
    
    for mission in expired_missions:
        mission.status = 'completed'
        # é‡Šæ”¾ç©ºåŸŸ...
    
    db.session.commit()

# å¯åŠ¨æ—¶æ³¨å†Œ
scheduler = BackgroundScheduler()
scheduler.add_job(check_and_complete_expired_missions, 'interval', minutes=1)
scheduler.start()
```

### 2. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
```sql
-- ä¸ºä»»åŠ¡æŸ¥è¯¢æ·»åŠ å¤åˆç´¢å¼•
CREATE INDEX idx_mission_status_endtime ON missions(status, end_time);

-- ä¸ºé£è¡Œç”³è¯·æŸ¥è¯¢æ·»åŠ ç´¢å¼•
CREATE INDEX idx_flight_app_status_endtime ON flight_applications(status, planned_end_time);
```

### 3. æ—¥å¿—çº§åˆ«ç®¡ç†
```python
# ç”Ÿäº§ç¯å¢ƒå…³é—­DEBUGæ—¥å¿—ï¼Œä½¿ç”¨é…ç½®æ§åˆ¶
import logging
logger = logging.getLogger(__name__)

# å°†print()æ›¿æ¢ä¸ºlogger
logger.debug(f"æ”¾é£æ—¶é—´æ£€æŸ¥: {now}")  # å¼€å‘ç¯å¢ƒæ˜¾ç¤º
logger.info(f"è‡ªåŠ¨ç»“æŸä»»åŠ¡ #{mission.id}")  # ç”Ÿäº§ç¯å¢ƒæ˜¾ç¤º
```

### 4. å‰ç«¯æ—¶é—´ç¼“å­˜
```javascript
// é¿å…é‡å¤è½¬æ¢ï¼Œä½¿ç”¨computedç¼“å­˜
const formattedTimes = computed(() => {
  return missions.map(m => ({
    ...m,
    displayStartTime: dayjs.utc(m.start_time).local().format(...)
  }))
})
```

---

## å·²çŸ¥é™åˆ¶

1. **æ—¶åŒºå‡è®¾**ï¼šç³»ç»Ÿå‡è®¾æ‰€æœ‰ç”¨æˆ·åœ¨åŒä¸€æ—¶åŒºï¼ˆUTC+8ï¼‰ï¼Œå¤šæ—¶åŒºæ”¯æŒéœ€é¢å¤–å¼€å‘
2. **ä»»åŠ¡ç»“æŸå»¶è¿Ÿ**ï¼šä»»åŠ¡è‡ªåŠ¨ç»“æŸä¾èµ–å‰ç«¯åˆ·æ–°è§¦å‘ï¼Œæœ€å¤§å»¶è¿Ÿå–å†³äºç”¨æˆ·æ“ä½œé¢‘ç‡
3. **å†å²æ•°æ®**ï¼šæœ¬æ¬¡ä¿®å¤å‰åˆ›å»ºçš„ä»»åŠ¡å¯èƒ½ä»æœ‰æ—¶é—´åå·®ï¼Œå»ºè®®æ‰‹åŠ¨ä¿®æ­£æˆ–æ•°æ®è¿ç§»



---

## é™„å½•ï¼šæ—¶åŒºè½¬æ¢é€ŸæŸ¥è¡¨

| æ“ä½œ | Pythonåç«¯ | JavaScriptå‰ç«¯ |
|------|-----------|---------------|
| è·å–å½“å‰UTCæ—¶é—´ | `datetime.now(timezone.utc).replace(tzinfo=None)` | `dayjs.utc()` |
| UTCè½¬æœ¬åœ°æ˜¾ç¤º | ä¸éœ€è¦ï¼ˆå‰ç«¯å¤„ç†ï¼‰ | `dayjs.utc(utcTime).local()` |
| æœ¬åœ°è½¬UTCå‘é€ | ä¸éœ€è¦ï¼ˆå‰ç«¯å¤„ç†ï¼‰ | `dayjs(localTime).utc()` |
| æ ¼å¼åŒ–UTCæ—¶é—´ | `dt.isoformat()` | `dayjs.utc(time).format()` |
| æ ¼å¼åŒ–æœ¬åœ°æ—¶é—´ | - | `dayjs.utc(time).local().format('YYYY-MM-DD HH:mm')` |

---

**END OF DOCUMENT**
