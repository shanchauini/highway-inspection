# åœ°å›¾æ€»è§ˆæ¨¡å—å®Œæ•´åˆ†æ

## ğŸ“š æ¨¡å—æ¦‚è¿°

**åœ°å›¾æ€»è§ˆæ¨¡å—**æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒå¯è§†åŒ–æ¨¡å—ï¼Œä¸»è¦åŠŸèƒ½æ˜¯åœ¨åœ°å›¾ä¸Šå®æ—¶æ˜¾ç¤ºï¼š
- æ­£åœ¨æ‰§è¡Œçš„é£è¡Œä»»åŠ¡
- æ— äººæœºçš„é£è¡Œèˆªçº¿
- ä»»åŠ¡è¯¦ç»†ä¿¡æ¯

---

## ğŸ—ï¸ å¼€å‘é¡ºåºï¼ˆæŒ‰ç…§MVCæ¶æ„ï¼‰

**æ ‡å‡†å¼€å‘é¡ºåº**ï¼šæ•°æ®æ¨¡å‹ â†’ ä¸šåŠ¡é€»è¾‘ â†’ APIè·¯ç”± â†’ å‰ç«¯æ¥å£ â†’ å‰ç«¯é¡µé¢

---

## ç¬¬ä¸€æ­¥ï¼šåç«¯æ•°æ®æ¨¡å‹ï¼ˆModelsï¼‰

### 1. Mission æ¨¡å‹ï¼ˆé£è¡Œä»»åŠ¡ï¼‰

**æ–‡ä»¶**ï¼š`app/models/mission.py`

**æ ¸å¿ƒå­—æ®µ**ï¼š
- `id`ï¼šä»»åŠ¡ID
- `flight_application_id`ï¼šå…³è”é£è¡Œç”³è¯·
- `operator_id`ï¼šå…³è”æ“ä½œå‘˜
- `route`ï¼šèˆªçº¿åæ ‡ï¼ˆJSONæ ¼å¼ï¼‰
- `status`ï¼šä»»åŠ¡çŠ¶æ€ï¼ˆ`executing` æˆ– `completed`ï¼‰
- `start_time`ï¼šå®é™…å¼€å§‹æ—¶é—´
- `end_time`ï¼šå®é™…ç»“æŸæ—¶é—´

**æ ¸å¿ƒæ–¹æ³•**ï¼š
- `get_route_coordinates()`ï¼šè§£æèˆªçº¿JSON
- `calculate_route_distance()`ï¼šè®¡ç®—èˆªçº¿è·ç¦»ï¼ˆä½¿ç”¨Haversineå…¬å¼ï¼‰
- `calculate_flight_speed()`ï¼šè®¡ç®—é£è¡Œé€Ÿåº¦
- `to_dict(include_relations=True)`ï¼šè½¬æ¢ä¸ºå­—å…¸ï¼ŒåŒ…å«å…³è”æ•°æ®

### 2. Airspace æ¨¡å‹ï¼ˆç©ºåŸŸï¼‰

**æ–‡ä»¶**ï¼š`app/models/airspace.py`

**æ ¸å¿ƒå­—æ®µ**ï¼š
- `type`ï¼šç©ºåŸŸç±»å‹ï¼ˆ`suitable`é€‚é£åŒºã€`restricted`é™åˆ¶åŒºã€`no_fly`ç¦é£åŒºï¼‰
- `area`ï¼šç©ºåŸŸèŒƒå›´ï¼ˆGeoJSONå¤šè¾¹å½¢ï¼‰
- `status`ï¼šç©ºåŸŸçŠ¶æ€ï¼ˆ`available`å¯ç”¨ã€`occupied`å ç”¨ã€`unavailable`ä¸å¯ç”¨ï¼‰

---

## ç¬¬äºŒæ­¥ï¼šåç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆServicesï¼‰

### AirspaceService

**æ–‡ä»¶**ï¼š`app/services/airspace_service.py`

**æ ¸å¿ƒæ–¹æ³•**ï¼š
1. `get_available_airspaces()`ï¼šè·å–æ‰€æœ‰å¯ç”¨ç©ºåŸŸï¼ˆæ’é™¤ç¦é£åŒºï¼‰
2. `check_airspace_conflict()`ï¼šæ£€æŸ¥ç©ºåŸŸæ—¶é—´å†²çª
3. `get_airspace_list()`ï¼šåˆ†é¡µè·å–ç©ºåŸŸåˆ—è¡¨

**ä¸šåŠ¡è§„åˆ™**ï¼š
- ç©ºåŸŸçŠ¶æ€`occupied`åªèƒ½ç”±ä»»åŠ¡è‡ªåŠ¨ç®¡ç†
- åˆ é™¤ç©ºåŸŸå‰æ£€æŸ¥æ˜¯å¦æœ‰å…³è”ç”³è¯·

---

## ç¬¬ä¸‰æ­¥ï¼šåç«¯APIè·¯ç”±ï¼ˆRoutesï¼‰

### Missions API

**æ–‡ä»¶**ï¼š`app/routes/missions.py`

#### æ ¸å¿ƒæ¥å£ï¼š

**â‘  GET `/missions/active` - è·å–è¿›è¡Œä¸­çš„ä»»åŠ¡**
```python
# ç”¨é€”ï¼šåœ°å›¾æ˜¾ç¤º
# æƒé™ï¼šç™»å½•ç”¨æˆ·ï¼Œæ“ä½œå‘˜åªçœ‹è‡ªå·±çš„
# è¿”å›ï¼šstatus='executing'çš„æ‰€æœ‰ä»»åŠ¡
```

**â‘¡ GET `/missions` - è·å–ä»»åŠ¡åˆ—è¡¨**
```python
# æ”¯æŒåˆ†é¡µå’ŒçŠ¶æ€ç­›é€‰
# å‚æ•°ï¼špage, page_size, status
```

**â‘¢ POST `/missions/<id>/complete` - å®Œæˆä»»åŠ¡**
```python
# æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºcompleted
# è®¾ç½®end_time
# é‡Šæ”¾ç©ºåŸŸï¼ˆstatusæ”¹ä¸ºavailableï¼‰
```

**âš ï¸ å¾…å®Œå–„**ï¼š
- å®Œæˆä»»åŠ¡æ—¶éœ€æ›´æ–°`AirspaceUsage`çŠ¶æ€
- éœ€å®ç°ä»»åŠ¡è‡ªåŠ¨å®Œæˆæœºåˆ¶

---

## ç¬¬å››æ­¥ï¼šå‰ç«¯APIæ¥å£ï¼ˆTypeScriptï¼‰

**æ–‡ä»¶**ï¼š`src/api/modules.ts`

```typescript
// åœ°å›¾API
export const mapApi = {
  getAvailableAirspaces: () => airspaceApi.getAvailableAirspaces(),
  getActiveMissions: () => missionApi.getActiveMissions()
}

// ä»»åŠ¡API
export const missionApi = {
  getMissions: (params) => api.get('/missions', { params }),
  getActiveMissions: () => api.get('/missions/active'),
  completeMission: (id) => api.post(`/missions/${id}/complete`)
}
```

---

## ç¬¬äº”æ­¥ï¼šå‰ç«¯çŠ¶æ€ç®¡ç†ï¼ˆPinia Storeï¼‰

### MissionStore

**æ–‡ä»¶**ï¼š`src/stores/mission.ts`

```typescript
export interface Mission {
  id: number
  operator_id: number
  route: number[][] | { coordinates?: number[][] }
  status: 'executing' | 'completed'
  route_distance?: number  // èˆªçº¿è·ç¦»ï¼ˆkmï¼‰
  flight_speed?: number    // é£è¡Œé€Ÿåº¦ï¼ˆkm/hï¼‰
  operator?: any
  flight_application?: any
}

// æ ¸å¿ƒæ–¹æ³•
fetchActiveMissions()  // è·å–è¿›è¡Œä¸­ä»»åŠ¡
completeMission(id)    // å®Œæˆä»»åŠ¡
```

---

## ç¬¬å…­æ­¥ï¼šå‰ç«¯é¡µé¢ç»„ä»¶

**æ–‡ä»¶**ï¼š`src/views/Map.vue`

### é¡µé¢å¸ƒå±€ï¼ˆä¸‰æ ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åœ°å›¾æ€»è§ˆ         [å®šä½] [æŸ¥çœ‹æ— äººæœºè§†é¢‘ç”»é¢]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¿›è¡Œä¸­   â”‚                  â”‚   ä»»åŠ¡è¯¦æƒ…       â”‚
â”‚ ä»»åŠ¡åˆ—è¡¨ â”‚   åœ°å›¾æ˜¾ç¤ºåŒºåŸŸ   â”‚                  â”‚
â”‚ [åˆ·æ–°]   â”‚  (Leaflet Map)   â”‚   - ä»»åŠ¡ID       â”‚
â”‚ ä»»åŠ¡1    â”‚   - æ˜¾ç¤ºèˆªçº¿     â”‚   - æ“ä½œå‘˜       â”‚
â”‚ ä»»åŠ¡2    â”‚   - æ— äººæœºå›¾æ ‡   â”‚   - é£è¡Œé€Ÿåº¦     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒåŠŸèƒ½å®ç°

#### 1. åœ°å›¾åˆå§‹åŒ–
```typescript
onMounted(async () => {
  // åˆ›å»ºLeafletåœ°å›¾
  map = L.map('map', {
    center: [39.9042, 116.4074],  // åŒ—äº¬
    zoom: 10
  })
  
  // æ·»åŠ é«˜å¾·åœ°å›¾åº•å›¾
  L.tileLayer('https://wprd0{s}.is.autonavi.com/...').addTo(map)
  
  // åŠ è½½ä»»åŠ¡
  await refreshMissions()
})
```

#### 2. åæ ‡è½¬æ¢ï¼ˆé‡è¦ï¼ï¼‰
```typescript
const coordsFromRoute = (route: any): Array<[number, number]> => {
  const raw = Array.isArray(route) ? route : (route.coordinates || [])
  
  // GeoJSON [lng, lat] â†’ Leaflet [lat, lng]
  return raw.map((c: number[]) => [c[1], c[0]])
}
```

**âš ï¸ åæ ‡é¡ºåº**ï¼š
- GeoJSONï¼š`[ç»åº¦, çº¬åº¦]` = `[116.4, 39.9]`
- Leafletï¼š`[çº¬åº¦, ç»åº¦]` = `[39.9, 116.4]`

#### 3. æ¸²æŸ“ä»»åŠ¡
```typescript
const renderMission = (m?: Mission) => {
  // æ¸…é™¤æ—§å›¾å±‚
  if (routeLayer) map.removeLayer(routeLayer)
  if (droneMarker) map.removeLayer(droneMarker)
  
  // è·å–åæ ‡
  const latlngs = coordsFromRoute(m.route)
  
  // ç»˜åˆ¶èˆªçº¿ï¼ˆè“è‰²æŠ˜çº¿ï¼‰
  routeLayer = L.polyline(latlngs, { 
    color: '#409EFF', 
    weight: 3 
  }).addTo(map)
  
  // è‡ªåŠ¨è°ƒæ•´è§†é‡
  map.fitBounds(routeLayer.getBounds())
  
  // æ·»åŠ æ— äººæœºå›¾æ ‡ï¼ˆèµ·ç‚¹ï¼‰
  droneMarker = L.marker(latlngs[0], { 
    icon: L.divIcon({ html: 'ğŸ›©ï¸' })
  }).addTo(map)
}
```

---

## ğŸ“Š å®Œæ•´æ•°æ®æµ

```
ç”¨æˆ·æ‰“å¼€é¡µé¢
    â†“
Map.vue onMounted()
    â†“
MissionStore.fetchActiveMissions()
    â†“
HTTP GET /api/missions/active
    â†“
åç«¯ missions.py get_active_missions()
    â†“
æŸ¥è¯¢æ•°æ®åº“ Mission.query.filter_by(status='executing')
    â†“
è¿”å›JSON [{id, route, operator, ...}]
    â†“
å‰ç«¯æ›´æ–° activeMissions
    â†“
Map.vue æ¸²æŸ“ï¼š
  - å·¦ä¾§æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨
  - åœ°å›¾ç»˜åˆ¶èˆªçº¿å’Œæ— äººæœºå›¾æ ‡
  - å³ä¾§æ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…
```

---

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

### 1. æƒé™æ§åˆ¶
```python
# æ“ä½œå‘˜åªèƒ½çœ‹è‡ªå·±çš„ä»»åŠ¡
if not user.is_admin():
    query = query.filter_by(operator_id=user_id)
```

### 2. å…³è”æ•°æ®åŠ è½½
```python
# include_relations=True åŒ…å«æ“ä½œå‘˜å’Œé£è¡Œç”³è¯·ä¿¡æ¯
mission.to_dict(include_relations=True)
```

### 3. åœ°å›¾è‡ªé€‚åº”
```typescript
// è‡ªåŠ¨è°ƒæ•´è§†é‡æ˜¾ç¤ºå®Œæ•´èˆªçº¿
map.fitBounds(routeLayer.getBounds(), { padding: [24, 24] })
```

---

## âš ï¸ éœ€è¦å®Œå–„çš„åŠŸèƒ½

### 1. å®Œæˆä»»åŠ¡æ—¶æ›´æ–°AirspaceUsage
**ä½ç½®**ï¼š`missions.py:131`
```python
# TODO: æ›´æ–°AirspaceUsageçŠ¶æ€ä¸ºreleased
```

### 2. ä»»åŠ¡è‡ªåŠ¨å®Œæˆ
**ä½ç½®**ï¼š`missions.py:132`
```python
# TODO: å®šæ—¶ä»»åŠ¡æ£€æŸ¥è¶…æ—¶ä»»åŠ¡å¹¶è‡ªåŠ¨å®Œæˆ
```

### 3. å®æ—¶ä½ç½®æ›´æ–°
- å½“å‰æ— äººæœºå›¾æ ‡å›ºå®šåœ¨èµ·ç‚¹
- éœ€è¦WebSocketæˆ–è½®è¯¢å®ç°å®æ—¶ä½ç½®

---

## ğŸ“ æ€»ç»“

**åœ°å›¾æ€»è§ˆæ¨¡å—æ ¸å¿ƒæµç¨‹**ï¼š
1. åç«¯æä¾›`/missions/active`æ¥å£è¿”å›æ‰§è¡Œä¸­ä»»åŠ¡
2. å‰ç«¯è°ƒç”¨æ¥å£è·å–ä»»åŠ¡æ•°æ®
3. è§£æä»»åŠ¡çš„`route`å­—æ®µï¼ˆèˆªçº¿åæ ‡ï¼‰
4. è½¬æ¢åæ ‡æ ¼å¼ï¼ˆGeoJSON â†’ Leafletï¼‰
5. åœ¨åœ°å›¾ä¸Šç»˜åˆ¶èˆªçº¿å’Œæ— äººæœºå›¾æ ‡
6. æ˜¾ç¤ºä»»åŠ¡è¯¦ç»†ä¿¡æ¯

**æŠ€æœ¯æ ˆ**ï¼š
- åç«¯ï¼šFlask + SQLAlchemy + GeoJSON
- å‰ç«¯ï¼šVue 3 + Leaflet + Pinia
- åœ°å›¾ï¼šé«˜å¾·åœ°å›¾ç“¦ç‰‡æœåŠ¡
