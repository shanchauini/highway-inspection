# 前后端连接指南

## 📋 配置说明

### 后端配置
- 默认端口：`5000`（可在 `.env` 中配置 `PORT`）
- CORS 已配置允许前端地址：`http://localhost:5173`
- JWT 认证已配置

### 前端配置
- 创建 `.env.development` 文件配置 API 地址
- 默认 API 地址：`http://localhost:3000/api`（根据后端实际端口调整）

## 🚀 启动步骤

### 步骤1：启动后端
```bash
cd highway-inspection-backend

# 激活虚拟环境
venv\Scripts\activate

# 启动后端服务
python run.py
```

**验证后端运行：**
- 浏览器访问：`http://localhost:5000/health`（或你配置的端口）
- 应该看到：`{"status": "ok", "message": "Highway Inspection Backend is running"}`

### 步骤2：启动前端
```bash
cd highway-inspection-frontend

# 启动前端服务
npm run dev
```

**验证前端运行：**
- 浏览器访问：`http://localhost:5173`
- 应该看到登录页面

### 步骤3：测试登录
1. 打开 `http://localhost:5173`
2. 打开浏览器开发者工具 (F12)
3. 使用测试账号登录：
   - 用户名：`operator1`
   - 密码：`op123`
4. 在 Network 面板中观察：
   - 请求地址应该是：`http://localhost:5000/api/auth/login`（或你配置的端口）
   - 状态码应该是：`200`
   - 响应应该包含 `access_token`

## 🔍 验证连接

### 方法1：使用诊断脚本（推荐）
```bash
cd highway-inspection-backend
python diagnose.py
```

应该看到所有测试通过：
```
[Test 1] Backend Health Check - OK
[Test 2] Test Login API - OK
[Test 3] Access Airspace API with Token - OK
[Test 4] CORS Configuration - OK
All Tests Passed!
```

### 方法2：浏览器手动验证
1. 打开 `http://localhost:5173`
2. 按 F12 打开开发者工具
3. 切换到 Network 标签
4. 登录测试
5. 查看请求状态码和响应

### 方法3：浏览器Console测试
在浏览器Console中执行（替换为实际端口）：
```javascript
fetch('http://localhost:5000/health')
  .then(res => res.json())
  .then(data => console.log('后端连接成功:', data))
  .catch(err => console.error('连接失败:', err))
```

## 📝 测试账号

| 用户名 | 密码 | 角色 | 权限 |
|--------|------|------|------|
| admin | admin123 | 管理员 | 全部权限 |
| operator1 | op123 | 操作员 | 基础权限 |
| operator2 | op123 | 操作员 | 基础权限 |

## 🐛 常见问题排查

### 问题1：前端无法连接后端
**症状：** Network面板显示请求失败或CORS错误

**解决：**
1. 确认后端已启动（检查实际端口）
   ```bash
   curl http://localhost:5000/health  # 或你配置的端口
   ```

2. 确认前端 `.env.development` 文件存在且配置正确
   ```bash
   # Windows PowerShell
   Get-Content highway-inspection-frontend/.env.development
   # 应该看到：VITE_API_BASE_URL=http://localhost:3000/api
   ```

3. 重启前端服务（配置文件修改后需要重启）
   ```bash
   # Ctrl+C 停止，然后重新运行
   npm run dev
   ```

### 问题2：登录失败
**症状：** 返回401或用户名密码错误

**解决：**
1. 确认数据库已初始化
   ```bash
   cd highway-inspection-backend
   python init_db.py
   ```

2. 检查数据库连接
   - 打开 `highway-inspection-backend/.env`
   - 确认 `DB_PASSWORD` 正确
   - 确认MySQL服务已启动

### 问题3：Token验证失败
**症状：** 登录成功但访问其他接口返回401

**解决：**
- 这个问题已经修复（JWT identity类型问题）
- 如果还有问题，重启后端服务

### 问题4：端口被占用
**症状：** 启动服务时提示端口已被使用

**解决：**
```bash
# 查看端口占用（Windows）
netstat -ano | findstr :5000  # 后端端口
netstat -ano | findstr :5173  # 前端端口

# 修改端口配置
# 后端：在 .env 中设置 PORT=其他端口
# 前端：npm run dev -- --port 其他端口
```

### 问题5：CORS跨域错误
**症状：** 浏览器Console显示CORS policy错误

**解决：**
- 后端的CORS配置已包含 `http://localhost:5173`
- 如果还有问题，清除浏览器缓存
- 确保前端和后端都已重启

## 🎯 验证连接成功

✅ **后端运行正常**
- `http://localhost:5000/health` 返回成功响应
- 终端显示服务运行信息

✅ **前端运行正常**
- `http://localhost:5173` 可以访问
- 显示登录页面

✅ **前后端连接成功**
- 登录时 Network 面板显示请求成功
- 状态码 200，响应包含 token
- 登录后可以正常访问其他页面

## 📞 需要帮助？

1. 查看后端终端错误信息
2. 查看浏览器 Console 错误信息
3. 查看浏览器 Network 面板请求详情
4. 运行诊断脚本：`python diagnose.py`

