# 前后端连接指南

## ✅ 已完成的配置

### 1. 后端配置
- ✅ 端口已改为 3000 (在 `.env` 文件中)
- ✅ CORS已配置允许前端地址：`http://localhost:5173`
- ✅ JWT认证问题已修复
- ✅ 数据库连接正常
- ✅ 测试数据已初始化

### 2. 前端配置
- ✅ 创建了 `.env.development` 文件
- ✅ API地址配置为: `http://localhost:3000/api`
- ✅ Mock数据已关闭

### 3. 已修复的问题
- ✅ JWT Token验证问题（identity类型不匹配）
- ✅ 所有路由中的user_id转换问题

## 🚀 启动步骤

### 步骤1：启动后端
```bash
cd highway-inspection-backend

# 激活虚拟环境
venv\Scripts\activate

# 启动后端服务
python run.py
```

**验证后端运行：**
- 浏览器访问：`http://localhost:3000/health`
- 应该看到：`{"status": "ok", "message": "Highway Inspection Backend is running"}`

### 步骤2：启动前端
```bash
cd highway-inspection-frontend

# 启动前端服务
npm run dev
```

**验证前端运行：**
- 浏览器访问：`http://localhost:5173`
- 应该看到登录页面

### 步骤3：测试登录
1. 打开 `http://localhost:5173`
2. 打开浏览器开发者工具 (F12)
3. 使用测试账号登录：
   - 用户名：`operator1`
   - 密码：`op123`
4. 在 Network 面板中观察：
   - 请求地址应该是：`http://localhost:3000/api/auth/login`
   - 状态码应该是：`200`
   - 响应应该包含 `access_token`

## 🔍 验证连接

### 方法1：使用诊断脚本（推荐）
```bash
cd highway-inspection-backend
python diagnose.py
```

应该看到所有测试通过：
```
[Test 1] Backend Health Check - OK
[Test 2] Test Login API - OK
[Test 3] Access Airspace API with Token - OK
[Test 4] CORS Configuration - OK
All Tests Passed!
```

### 方法2：浏览器手动验证
1. 打开 `http://localhost:5173`
2. 按 F12 打开开发者工具
3. 切换到 Network 标签
4. 登录测试
5. 查看请求：
   - 应该看到请求发往 `http://localhost:3000/api/auth/login`
   - 状态码 200
   - 响应包含 token

### 方法3：浏览器Console测试
在浏览器Console中执行：
```javascript
fetch('http://localhost:3000/health')
  .then(res => res.json())
  .then(data => console.log('后端连接成功:', data))
  .catch(err => console.error('连接失败:', err))
```

## 📝 测试账号

| 用户名 | 密码 | 角色 | 权限 |
|--------|------|------|------|
| admin | admin123 | 管理员 | 全部权限 |
| operator1 | op123 | 操作员 | 基础权限 |
| operator2 | op123 | 操作员 | 基础权限 |

## 🐛 常见问题排查

### 问题1：前端无法连接后端
**症状：** Network面板显示请求失败或CORS错误

**解决：**
1. 确认后端已启动且运行在 3000 端口
   ```bash
   curl http://localhost:3000/health
   ```

2. 确认前端 `.env.development` 文件存在且配置正确
   ```bash
   cat highway-inspection-frontend/.env.development
   # 应该看到：VITE_API_BASE_URL=http://localhost:3000/api
   ```

3. 重启前端服务（配置文件修改后需要重启）
   ```bash
   # Ctrl+C 停止，然后重新运行
   npm run dev
   ```

### 问题2：登录失败
**症状：** 返回401或用户名密码错误

**解决：**
1. 确认数据库已初始化
   ```bash
   cd highway-inspection-backend
   python init_db.py
   ```

2. 检查数据库连接
   - 打开 `highway-inspection-backend/.env`
   - 确认 `DB_PASSWORD` 正确
   - 确认MySQL服务已启动

### 问题3：Token验证失败
**症状：** 登录成功但访问其他接口返回401

**解决：**
- 这个问题已经修复（JWT identity类型问题）
- 如果还有问题，重启后端服务

### 问题4：端口被占用
**症状：** 启动服务时提示端口已被使用

**解决：**
```bash
# 查看3000端口占用
netstat -ano | findstr :3000

# 查看5173端口占用
netstat -ano | findstr :5173

# 关闭占用进程或修改端口
```

### 问题5：CORS跨域错误
**症状：** 浏览器Console显示CORS policy错误

**解决：**
- 后端的CORS配置已包含 `http://localhost:5173`
- 如果还有问题，清除浏览器缓存
- 确保前端和后端都已重启

## 📊 API接口测试

### 使用Postman/Apifox测试

#### 1. 登录获取Token
```
POST http://localhost:3000/api/auth/login
Content-Type: application/json

{
  "username": "operator1",
  "password": "op123"
}
```

#### 2. 使用Token访问接口
```
GET http://localhost:3000/api/airspaces
Authorization: Bearer <从登录响应中获取的token>
```

#### 3. 测试创建飞行申请
```
POST http://localhost:3000/api/flights
Authorization: Bearer <token>
Content-Type: application/json

{
  "drone_model": "DJI Mavic 3",
  "task_purpose": "测试巡检",
  "planned_airspace_id": 1,
  "planned_start_time": "2024-12-01T09:00:00",
  "planned_end_time": "2024-12-01T11:00:00",
  "total_time": 120,
  "route": {
    "type": "LineString",
    "coordinates": [[116.39, 39.90], [116.41, 39.92]]
  },
  "is_long_term": false
}
```

## 🎯 验证前后端连接成功的标志

✅ **后端运行正常**
- `http://localhost:3000/health` 返回成功响应
- 终端显示 "Server running on: http://0.0.0.0:3000"

✅ **前端运行正常**
- `http://localhost:5173` 可以访问
- 显示登录页面

✅ **前后端连接成功**
- 登录时 Network面板显示请求到 `http://localhost:3000/api/auth/login`
- 状态码 200
- 响应包含用户信息和token
- 登录后可以访问其他页面（空域管理、飞行申请等）
- 页面能正常显示数据（如空域列表）

✅ **权限控制生效**
- 操作员只能看到自己的申请
- 管理员可以看到所有数据
- 未登录访问自动跳转到登录页

## 📞 需要帮助？

如果遇到其他问题：

1. 查看后端终端输出的错误信息
2. 查看浏览器Console的错误信息
3. 查看浏览器Network面板的请求详情
4. 运行诊断脚本：`python diagnose.py`

---

**当前状态：✅ 前后端已成功连接！**

所有测试通过，可以正常使用系统了！

