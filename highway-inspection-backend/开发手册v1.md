# 后端开发手册v1

更新日期：2025.11.8
## 目录
1. [项目架构](#项目架构)
2. [用户认证模块](#用户认证模块)
3. [用户管理模块](#用户管理模块)
4. [飞行申请管理模块](#飞行申请管理模块)
5. [空域管理模块](#空域管理模块)
6. [API接口规范](#api接口规范)
7. [数据模型](#数据模型)
8. [权限控制](#权限控制)

---

## 项目架构

### 技术栈
- **框架**: Flask 3.0.0
- **ORM**: SQLAlchemy 2.0
- **认证**: Flask-JWT-Extended 4.6.0
- **数据验证**: Marshmallow 3.20.1
- **数据库**: MySQL (PyMySQL)
- **CORS**: Flask-CORS

### 项目结构
```
highway-inspection-backend/
├── app/
│   ├── __init__.py          # 应用工厂函数
│   ├── models/              # 数据模型
│   │   ├── user.py          # 用户模型
│   │   ├── airspace.py      # 空域模型
│   │   ├── flight_application.py  # 飞行申请模型
│   │   ├── alert.py         # 告警模型
│   │   ├── mission.py       # 任务模型
│   │   └── video.py         # 视频模型
│   ├── routes/              # 路由蓝图
│   │   ├── auth.py          # 认证路由
│   │   ├── users.py         # 用户管理路由
│   │   ├── airspaces.py     # 空域管理路由
│   │   ├── flights.py       # 飞行申请路由
│   │   └── alerts.py        # 告警路由
│   ├── services/            # 业务逻辑层
│   │   ├── auth_service.py  # 认证服务
│   │   ├── flight_service.py # 飞行申请服务
│   │   └── airspace_service.py # 空域服务
│   ├── schemas/             # 数据验证Schema
│   │   ├── user_schema.py
│   │   ├── flight_schema.py
│   │   └── airspace_schema.py
│   └── utils/               # 工具函数
│       ├── decorators.py    # 装饰器（权限控制）
│       └── response.py      # 响应工具
├── config.py                # 配置文件
└── run.py                   # 启动文件
```

---

## 用户认证模块

### 1. 数据模型

**文件**: `app/models/user.py`

```python
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    password = db.Column(db.String(255), nullable=False)  # 哈希存储
    role = db.Column(db.Enum('operator', 'admin'), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

**字段说明**:
- `id`: 用户ID（主键）
- `username`: 用户名（唯一，3-80字符）
- `password`: 密码（使用werkzeug.security哈希存储）
- `role`: 角色（`operator`操作员 或 `admin`管理员）
- `created_at`: 创建时间
- `updated_at`: 更新时间

**方法**:
- `set_password(password)`: 设置密码（自动哈希）
- `check_password(password)`: 验证密码
- `is_admin()`: 判断是否是管理员
- `to_dict()`: 转换为字典（不包含密码）

### 2. API接口

**文件**: `app/routes/auth.py`

#### 2.1 用户注册
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "operator1",
  "password": "password123",
  "role": "operator"  // 可选，默认为"operator"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "id": 1,
    "username": "operator1",
    "role": "operator",
    "created_at": "2024-01-01T00:00:00",
    "updated_at": "2024-01-01T00:00:00"
  }
}
```

**验证规则** (UserRegisterSchema):
- `username`: 必填，3-80字符
- `password`: 必填，4-128字符
- `role`: 可选，必须是`operator`或`admin`，默认`operator`

**业务逻辑**:
- 检查用户名是否已存在
- 密码自动哈希存储
- 注册时默认角色为`operator`（管理员需手动创建）

#### 2.2 用户登录
```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "operator1",
  "password": "password123"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "user": {
      "id": 1,
      "username": "operator1",
      "role": "operator",
      "created_at": "2024-01-01T00:00:00",
      "updated_at": "2024-01-01T00:00:00"
    },
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc..."
  }
}
```

**验证规则** (UserLoginSchema):
- `username`: 必填，3-80字符
- `password`: 必填，4-128字符

**业务逻辑**:
- 验证用户名和密码
- 生成JWT token（identity为字符串格式的用户ID）
- Token有效期：24小时（可在config.py配置）

#### 2.3 获取当前用户
```http
GET /api/auth/current
Authorization: Bearer <token>
```

**响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "id": 1,
    "username": "operator1",
    "role": "operator",
    "created_at": "2024-01-01T00:00:00",
    "updated_at": "2024-01-01T00:00:00"
  }
}
```

**权限**: 需要登录（`@login_required`）

#### 2.4 用户登出
```http
POST /api/auth/logout
Authorization: Bearer <token>
```

**响应**:
```json
{
  "code": 200,
  "message": "登出成功"
}
```

**说明**: 前端删除token即可，后端无需特殊处理

### 3. 服务层

**文件**: `app/services/auth_service.py`

**AuthService类**:
- `register(username, password, role='operator')`: 用户注册
- `login(username, password)`: 用户登录，返回用户信息和token
- `get_user_by_id(user_id)`: 根据ID获取用户
- `update_user(user_id, **kwargs)`: 更新用户信息（支持密码更新）

---

## 用户管理模块

### 1. API接口

**文件**: `app/routes/users.py`

#### 1.1 获取用户列表
```http
GET /api/users?page=1&page_size=20&role=operator
Authorization: Bearer <token>
```

**权限**: 仅管理员（`@admin_required`）

**查询参数**:
- `page`: 页码（默认1）
- `page_size`: 每页数量（默认20）
- `role`: 角色筛选（可选，`operator`或`admin`）

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "username": "operator1",
        "role": "operator",
        "created_at": "2024-01-01T00:00:00",
        "updated_at": "2024-01-01T00:00:00"
      }
    ],
    "total": 10,
    "page": 1,
    "page_size": 20,
    "total_pages": 1
  }
}
```

#### 1.2 获取用户详情
```http
GET /api/users/{user_id}
Authorization: Bearer <token>
```

**权限**: 
- 管理员：可查看所有用户
- 普通用户：只能查看自己

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "username": "operator1",
    "role": "operator",
    "created_at": "2024-01-01T00:00:00",
    "updated_at": "2024-01-01T00:00:00"
  }
}
```

#### 1.3 更新用户信息
```http
PUT /api/users/{user_id}
Authorization: Bearer <token>
Content-Type: application/json

{
  "password": "newpassword123"  // 可选
  // 注意：普通用户不能修改role字段
}
```

**权限**:
- 管理员：可修改所有用户（包括角色）
- 普通用户：只能修改自己（不能修改角色）

**验证规则** (UserUpdateSchema):
- `password`: 可选，4-128字符
- `role`: 可选，必须是`operator`或`admin`（仅管理员可修改）

**响应**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": {
    "id": 1,
    "username": "operator1",
    "role": "operator",
    "created_at": "2024-01-01T00:00:00",
    "updated_at": "2024-01-01T00:00:00"
  }
}
```

#### 1.4 删除用户
```http
DELETE /api/users/{user_id}
Authorization: Bearer <token>
```

**权限**: 仅管理员（`@admin_required`）

**限制**: 不能删除自己

**响应**:
```json
{
  "code": 200,
  "message": "删除成功"
}
```

---

## 飞行申请管理模块

### 1. 数据模型

**文件**: `app/models/flight_application.py`

```python
class FlightApplication(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    drone_model = db.Column(db.String(100), nullable=False)
    task_purpose = db.Column(db.Text, nullable=False)
    planned_airspace_id = db.Column(db.Integer, db.ForeignKey('airspaces.id'), nullable=False)
    planned_start_time = db.Column(db.DateTime, nullable=False)
    planned_end_time = db.Column(db.DateTime, nullable=False)
    total_time = db.Column(db.Integer, nullable=False)  # 分钟
    route = db.Column(db.JSON, nullable=False)  # GeoJSON格式
    status = db.Column(db.Enum('draft', 'pending', 'approved', 'rejected', 'expired'), default='draft')
    is_long_term = db.Column(db.Boolean, default=False)
    long_term_start = db.Column(db.DateTime)
    long_term_end = db.Column(db.DateTime)
    rejection_reason = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

**状态流转**:
- `draft` → `pending` (提交申请)
- `pending` → `approved` (管理员批准)
- `pending` → `rejected` (管理员驳回)
- `pending` → `expired` (自动过期，定时任务检查)
- `approved` → 可执行放飞操作

### 2. API接口

**文件**: `app/routes/flights.py`

#### 2.1 获取飞行申请列表
```http
GET /api/flights?page=1&page_size=20&status=pending
Authorization: Bearer <token>
```

**权限**: 需要登录（`@login_required`）

**查询参数**:
- `page`: 页码（默认1）
- `page_size`: 每页数量（默认20）
- `status`: 状态筛选（可选：`draft`, `pending`, `approved`, `rejected`, `expired`）

**权限控制**:
- 管理员：可查看所有申请
- 操作员：只能查看自己的申请

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "user_id": 1,
        "drone_model": "DJI Mavic 3",
        "task_purpose": "公路巡检",
        "planned_airspace_id": 1,
        "planned_start_time": "2024-01-01T10:00:00",
        "planned_end_time": "2024-01-01T12:00:00",
        "total_time": 120,
        "route": {
          "type": "LineString",
          "coordinates": [[116.39, 39.90], [116.41, 39.92]]
        },
        "status": "pending",
        "applicant": {
          "id": 1,
          "username": "operator1",
          "role": "operator"
        },
        "airspace": {
          "id": 1,
          "name": "京港澳高速适飞区A",
          "number": "AS001"
        }
      }
    ],
    "total": 10,
    "page": 1,
    "page_size": 20,
    "total_pages": 1
  }
}
```

#### 2.2 获取飞行申请详情
```http
GET /api/flights/{flight_id}
Authorization: Bearer <token>
```

**权限**: 
- 管理员：可查看所有申请
- 操作员：只能查看自己的申请

#### 2.3 创建飞行申请
```http
POST /api/flights
Authorization: Bearer <token>
Content-Type: application/json

{
  "drone_model": "DJI Mavic 3",
  "task_purpose": "公路巡检任务",
  "planned_airspace_id": 1,
  "planned_start_time": "2024-01-01T10:00:00",
  "planned_end_time": "2024-01-01T12:00:00",
  "total_time": 120,
  "route": {
    "type": "LineString",
    "coordinates": [[116.39, 39.90], [116.41, 39.92]]
  },
  "is_long_term": false
}
```

**权限**: 需要登录（`@login_required`）

**验证规则** (FlightApplicationCreateSchema):
- `drone_model`: 必填，1-100字符
- `task_purpose`: 必填，至少1字符
- `planned_airspace_id`: 必填，整数
- `planned_start_time`: 必填，ISO格式日期时间
- `planned_end_time`: 必填，ISO格式日期时间
- `total_time`: 必填，整数（分钟）
- `route`: 必填，GeoJSON格式字典
- `is_long_term`: 可选，布尔值
- `long_term_start`: 可选，ISO格式日期时间
- `long_term_end`: 可选，ISO格式日期时间

**业务逻辑**:
- 自动设置`user_id`为当前登录用户
- 初始状态为`draft`（草稿）

**响应**: 返回创建的申请对象（包含关联数据）

#### 2.4 更新飞行申请
```http
PUT /api/flights/{flight_id}
Authorization: Bearer <token>
Content-Type: application/json

{
  "drone_model": "DJI Mavic 3 Pro",
  "task_purpose": "更新后的任务目的"
  // 其他字段可选
}
```

**权限**: 需要登录（`@login_required`）

**限制**:
- 只能修改自己创建的申请
- 只能修改`draft`状态的申请

**验证规则** (FlightApplicationUpdateSchema): 所有字段都是可选的

#### 2.5 提交飞行申请
```http
POST /api/flights/{flight_id}/submit
Authorization: Bearer <token>
```

**权限**: 需要登录（`@login_required`）

**业务逻辑**:
- 检查申请状态是否为`draft`
- 检查空域时间冲突
- 状态改为`pending`
- 创建空域使用记录（状态为`applied`）

**错误情况**:
- 申请不存在
- 无权限提交此申请
- 申请状态不允许提交
- 空域时间冲突

#### 2.6 批准飞行申请
```http
POST /api/flights/{flight_id}/approve
Authorization: Bearer <token>
```

**权限**: 仅管理员（`@admin_required`）

**业务逻辑**:
- 检查申请状态是否为`pending`
- 检查是否已过期
- 再次检查空域冲突（排除当前申请）
- 状态改为`approved`
- 更新空域使用记录状态为`approved`

#### 2.7 驳回飞行申请
```http
POST /api/flights/{flight_id}/reject
Authorization: Bearer <token>
Content-Type: application/json

{
  "rejection_reason": "空域已被占用"
}
```

**权限**: 仅管理员（`@admin_required`）

**业务逻辑**:
- 检查申请状态是否为`pending`
- 状态改为`rejected`
- 保存驳回理由

#### 2.8 放飞申请
```http
POST /api/flights/{flight_id}/launch
Authorization: Bearer <token>
```

**权限**: 需要登录（`@login_required`）

**业务逻辑**:
- 检查申请状态是否为`approved`
- 检查当前时间是否在申请的飞行时间范围内
- 检查空域是否可用（不能是`no_fly`类型，不能是`occupied`状态）
- 创建任务（Mission）对象，状态为`executing`
- 更新空域状态为`occupied`
- 更新空域使用记录状态为`active`

**响应**: 返回创建的任务对象

#### 2.9 获取待审批申请列表
```http
GET /api/flights/pending
Authorization: Bearer <token>
```

**权限**: 仅管理员（`@admin_required`）

**响应**: 返回所有`pending`状态的申请列表

### 3. 服务层

**文件**: `app/services/flight_service.py`

**FlightService类**:
- `create_application(user_id, **kwargs)`: 创建申请
- `update_application(application_id, user_id, **kwargs)`: 更新申请（仅草稿）
- `submit_application(application_id, user_id)`: 提交申请
- `approve_application(application_id)`: 批准申请
- `reject_application(application_id, rejection_reason)`: 驳回申请
- `launch_flight(application_id, user_id)`: 放飞申请，创建任务
- `get_application_list(user_id, is_admin, status, page, page_size)`: 获取申请列表
- `get_pending_applications()`: 获取待审批申请
- `check_expired_applications()`: 检查并更新过期申请（定时任务）

---

## 空域管理模块

### 1. 数据模型

**文件**: `app/models/airspace.py`

```python
class Airspace(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    number = db.Column(db.String(50), unique=True, nullable=False)  # 唯一编号
    type = db.Column(db.Enum('suitable', 'restricted', 'no_fly'), nullable=False)
    area = db.Column(db.JSON, nullable=False)  # GeoJSON格式
    remark = db.Column(db.Text)
    status = db.Column(db.Enum('available', 'occupied', 'unavailable'), default='available')
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

**类型说明**:
- `suitable`: 适飞区（绿色）
- `restricted`: 限制区（黄色）
- `no_fly`: 禁飞区（红色）

**状态说明**:
- `available`: 可用
- `occupied`: 占用中
- `unavailable`: 不可用

**GeoJSON格式**:
```json
{
  "type": "Polygon",
  "coordinates": [[[lng1, lat1], [lng2, lat2], [lng3, lat3], [lng1, lat1]]]
}
```

### 2. API接口

**文件**: `app/routes/airspaces.py`

#### 2.1 获取空域列表
```http
GET /api/airspaces?page=1&page_size=20&type=suitable&status=available
Authorization: Bearer <token>
```

**权限**: 需要登录（`@login_required`）

**查询参数**:
- `page`: 页码（默认1）
- `page_size`: 每页数量（默认20）
- `type`: 类型筛选（可选：`suitable`, `restricted`, `no_fly`）
- `status`: 状态筛选（可选：`available`, `occupied`, `unavailable`）

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "name": "京港澳高速适飞区A",
        "number": "AS001",
        "type": "suitable",
        "area": {
          "type": "Polygon",
          "coordinates": [[[116.39, 39.90], [116.41, 39.90], [116.41, 39.92], [116.39, 39.92], [116.39, 39.90]]]
        },
        "remark": "主要巡检区域A",
        "status": "available",
        "created_at": "2024-01-01T00:00:00",
        "updated_at": "2024-01-01T00:00:00"
      }
    ],
    "total": 10,
    "page": 1,
    "page_size": 20,
    "total_pages": 1
  }
}
```

#### 2.2 获取空域详情
```http
GET /api/airspaces/{airspace_id}
Authorization: Bearer <token>
```

#### 2.3 创建空域
```http
POST /api/airspaces
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "京港澳高速适飞区A",
  "number": "AS001",
  "type": "suitable",
  "area": {
    "type": "Polygon",
    "coordinates": [[[116.39, 39.90], [116.41, 39.90], [116.41, 39.92], [116.39, 39.92], [116.39, 39.90]]]
  },
  "remark": "主要巡检区域A",
  "status": "available"
}
```

**权限**: 仅管理员（`@admin_required`）

**验证规则** (AirspaceCreateSchema):
- `name`: 必填，1-100字符
- `number`: 必填，1-50字符，必须唯一
- `type`: 必填，必须是`suitable`、`restricted`或`no_fly`
- `area`: 必填，GeoJSON格式字典
- `remark`: 可选
- `status`: 可选，默认`available`

**业务逻辑**:
- 检查编号是否已存在
- 自动设置创建和更新时间

#### 2.4 更新空域
```http
PUT /api/airspaces/{airspace_id}
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "更新后的名称",
  "status": "occupied"
  // 其他字段可选
}
```

**权限**: 仅管理员（`@admin_required`）

**验证规则** (AirspaceUpdateSchema): 所有字段都是可选的

**业务逻辑**:
- 如果更新编号，检查新编号是否已存在

#### 2.5 删除空域
```http
DELETE /api/airspaces/{airspace_id}
Authorization: Bearer <token>
```

**权限**: 仅管理员（`@admin_required`）

**限制**: 如果存在关联的飞行申请，无法删除

#### 2.6 获取可用空域
```http
GET /api/airspaces/available
Authorization: Bearer <token>
```

**权限**: 需要登录（`@login_required`）

**响应**: 返回所有`type != 'no_fly'`且`status == 'available'`的空域列表

#### 2.7 检查空域时间冲突
```http
POST /api/airspaces/{airspace_id}/check-conflict
Authorization: Bearer <token>
Content-Type: application/json

{
  "start_time": "2024-01-01T10:00:00",
  "end_time": "2024-01-01T12:00:00"
}
```

**权限**: 需要登录（`@login_required`）

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "has_conflict": false
  }
}
```

**业务逻辑**:
- 检查指定时间段内是否有已批准或正在使用的空域使用记录
- 用于提交飞行申请前的冲突检查

### 3. 服务层

**文件**: `app/services/airspace_service.py`

**AirspaceService类**:
- `create_airspace(name, number, type, area, remark, status)`: 创建空域
- `update_airspace(airspace_id, **kwargs)`: 更新空域
- `delete_airspace(airspace_id)`: 删除空域
- `get_airspace_list(page, page_size, type, status)`: 获取空域列表
- `get_airspace_by_id(airspace_id)`: 根据ID获取空域
- `check_airspace_conflict(airspace_id, start_time, end_time, exclude_application_id)`: 检查时间冲突
- `update_airspace_status(airspace_id, status)`: 更新空域状态
- `get_available_airspaces()`: 获取所有可用空域

---

## API接口规范

### 统一响应格式

#### 成功响应
```json
{
  "code": 200,
  "message": "success",
  "data": { ... }
}
```

#### 错误响应
```json
{
  "code": 400,
  "message": "错误信息",
  "errors": {  // 可选，验证错误详情
    "field": ["错误1", "错误2"]
  }
}
```

#### 分页响应
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [...],
    "total": 100,
    "page": 1,
    "page_size": 20,
    "total_pages": 5
  }
}
```

### HTTP状态码
- `200`: 成功
- `201`: 创建成功
- `400`: 请求参数错误
- `401`: 未认证
- `403`: 无权限
- `404`: 资源不存在
- `500`: 服务器内部错误

### 认证方式
所有需要认证的接口都需要在请求头中携带JWT token：
```
Authorization: Bearer <token>
```

---

## 权限控制

### 装饰器

**文件**: `app/utils/decorators.py`

#### @login_required
- 验证JWT token
- 检查用户是否存在
- 适用于所有需要登录的接口

#### @admin_required
- 验证JWT token
- 检查用户是否存在
- 检查用户角色是否为`admin`
- 适用于仅管理员可访问的接口

### 权限矩阵

| 操作 | 操作员 | 管理员 |
|------|--------|--------|
| 注册 | ✅ (仅operator) | ✅ |
| 登录 | ✅ | ✅ |
| 查看自己信息 | ✅ | ✅ |
| 修改自己信息 | ✅ | ✅ |
| 修改自己密码 | ✅ | ✅ |
| 查看所有用户 | ❌ | ✅ |
| 修改其他用户 | ❌ | ✅ |
| 删除用户 | ❌ | ✅ |
| 创建空域 | ❌ | ✅ |
| 更新空域 | ❌ | ✅ |
| 删除空域 | ❌ | ✅ |
| 查看空域 | ✅ | ✅ |
| 创建飞行申请 | ✅ | ✅ |
| 查看自己的申请 | ✅ | ✅ |
| 查看所有申请 | ❌ | ✅ |
| 提交申请 | ✅ | ✅ |
| 批准申请 | ❌ | ✅ |
| 驳回申请 | ❌ | ✅ |
| 查看告警 | ✅ (仅自己任务的) | ✅ (全部) |
| 更新告警 | ✅ (仅自己任务的) | ✅ (全部) |

---

## 数据模型关系

### 用户 (User)
- 一对多 → 飞行申请 (FlightApplication)
- 一对多 → 任务 (Mission)

### 空域 (Airspace)
- 一对多 → 飞行申请 (FlightApplication)
- 一对多 → 空域使用记录 (AirspaceUsage)

### 飞行申请 (FlightApplication)
- 多对一 → 用户 (User)
- 多对一 → 空域 (Airspace)
- 一对多 → 任务 (Mission)
- 一对多 → 空域使用记录 (AirspaceUsage)

### 告警 (AlertEvent)
- 多对一 → 视频 (Video)
- 多对一 → 任务 (Mission)

---

## 注意事项

### 1. JWT Token
- Token的`identity`字段存储的是**字符串格式**的用户ID
- 使用时需要转换为整数：`int(get_jwt_identity())`
- Token有效期：24小时（可在config.py中配置）

### 2. 时间格式
- 所有日期时间字段使用ISO 8601格式：`YYYY-MM-DDTHH:mm:ss`
- 时区：UTC

### 3. GeoJSON格式
- 空域的`area`字段和飞行申请的`route`字段都使用GeoJSON格式
- 坐标顺序：`[longitude, latitude]`（注意：经度在前，纬度在后）

### 4. 空域冲突检查
- 提交申请时自动检查冲突
- 批准申请时再次检查冲突（排除当前申请）
- 冲突判断逻辑：时间段有重叠即认为冲突

### 5. 定时任务
- 每小时自动检查并更新过期的飞行申请
- 使用APScheduler实现

### 6. 密码安全
- 使用`werkzeug.security.generate_password_hash`哈希存储
- 使用`werkzeug.security.check_password_hash`验证

---



---

## 常见问题

### Q1: 为什么操作员看不到告警？
A: 操作员只能查看自己任务的告警。如果没有任务或任务没有告警，列表为空。管理员可以查看所有告警。

### Q2: 为什么提交申请时提示空域冲突？
A: 系统会检查申请时间段内是否有其他已批准或正在使用的空域使用记录。如果有重叠，则提示冲突。

### Q3: 如何创建管理员账号？
A: 可以通过注册接口创建，但需要手动设置`role`为`admin`，或者直接在数据库中修改。

### Q4: 飞行申请的状态如何流转？
A: `draft` → `pending` (提交) → `approved`/`rejected` (审批) → 可执行放飞

### Q5: 空域状态如何更新？
A: 管理员可以手动更新。当飞行申请被批准并执行放飞时，空域状态会自动更新为`occupied`。

