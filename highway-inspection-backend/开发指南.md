# 公路巡检飞行管理系统 - 后端开发指南

## 项目概述

本项目是公路巡检飞行管理系统的后端服务，使用 Flask 框架开发，采用前后端分离架构，提供 RESTful API 接口。

## 快速开始

### 第一步：环境准备
1. 安装 Python 3.8+
2. 安装 MySQL 8.0+
3. 安装 PyCharm（推荐）或其他IDE

### 第二步：项目安装
```bash

 cd highway-inspection-frontend
 npm run dev
 
cd highway-inspection-backend
venv\Scripts\activate
python run.py

http://localhost:5173/
# 进入项目目录
cd highway-inspection-backend

# 创建虚拟环境
python -m venv venv

ps:若python无效 可以使用py -m venv venv

# 激活虚拟环境（Windows）
venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```
ps:若当前下载的安装包已经有venv文件夹，先删除再操作

### 第三步：数据库配置
1. 创建数据库：
```sql
CREATE DATABASE highway_inspection_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

2. 导入数据库结构（执行提供的 SQL 文件）

ps:若直接导入highway_inspection_system_v2.sql文件，检查飞行计划申请表的status字段是否缺失draft字段，若缺少请更改表。

ALTER TABLE flight_applications 
MODIFY COLUMN status ENUM('draft', 'pending', 'approved', 'rejected','expired')  DEFAULT 'draft';
3. 复制并编辑配置文件：
```bash
copy env.example .env
```

编辑 `.env` 文件，修改数据库连接信息：
```
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=你的密码
DB_NAME=highway_inspection_system
```

### 第四步：初始化测试数据
```bash
python init_db.py
```

### 第五步：启动服务
```bash
# 方式1：直接运行
python run.py

# 方式2：使用启动脚本（Windows）
start.bat

# 方式3：使用启动脚本（Linux/Mac）
./start.sh
```

服务将在 `http://localhost:5000` 启动。

### 第六步：测试接口
```bash
python test_api.py
```

## 项目结构

```
highway-inspection-backend/
├── app/                      # 应用主目录
│   ├── models/              # 数据模型（数据库表定义）
│   ├── routes/              # 路由（API接口）
│   ├── services/            # 业务逻辑
│   ├── schemas/             # 数据验证
│   └── utils/               # 工具函数
├── config.py                # 配置文件
├── run.py                   # 启动文件
├── init_db.py              # 数据库初始化脚本
├── test_api.py             # API测试脚本
└── requirements.txt        # 依赖清单
```

## 核心功能模块

### 1. 用户认证模块
- **注册**: 操作员可自行注册
- **登录**: 返回 JWT token
- **权限控制**: 基于角色的访问控制

### 2. 空域管理模块
- **CRUD操作**: 创建、查询、更新、删除空域
- **冲突检测**: 时间和空间冲突检测
- **状态管理**: 可用、占用、不可用

### 3. 飞行申请模块
- **申请流程**: 草稿 → 提交 → 审批 → 批准/驳回
- **放飞检查**: 验证空域、时间等条件
- **状态跟踪**: 完整的申请生命周期管理

### 4. 飞行任务模块
- **任务执行**: 记录飞行任务状态
- **实时监控**: 提供进行中的任务列表
- **任务完成**: 更新状态，释放空域

### 5. 视频管理模块
- **视频上传**: 记录视频元数据
- **关联分析**: 与AI分析结果关联
- **查询检索**: 多条件查询

### 6. 告警管理模块
- **告警创建**: 由AI模块自动创建
- **状态管理**: 新发现 → 已确认 → 处理中 → 已关闭
- **实时监控**: 活跃告警列表

### 7. 数据看板模块
- **飞行统计**: 任务次数、时长统计
- **空域统计**: 使用频率和时长
- **告警统计**: 类型、严重程度分布
- **趋势分析**: 告警趋势图表

### 8. AI接口模块
- **分析结果接收**: 接收AI推送的分析结果
- **批量提交**: 支持批量数据提交
- **无需认证**: 供内部服务调用

## API接口规范

### 统一响应格式

**成功响应：**
```json
{
  "code": 200,
  "message": "success",
  "data": {...}
}
```

**错误响应：**
```json
{
  "code": 400,
  "message": "错误信息",
  "errors": {...}
}
```

**分页响应：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [...],
    "total": 100,
    "page": 1,
    "page_size": 20,
    "total_pages": 5
  }
}
```

### 认证方式

使用 JWT token 认证，在请求头中携带：
```
Authorization: Bearer <token>
```

### 接口列表

详见 `README.md` 中的完整API文档。

## 开发工作流程

### 1. 添加新功能模块

#### Step 1: 创建数据模型
在 `app/models/` 目录下创建新的模型文件：
```python
# app/models/new_model.py
from app.models import db
from datetime import datetime

class NewModel(db.Model):
    __tablename__ = 'new_table'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    def to_dict(self):
        return {
            'id': self.id,
            'name': self.name,
            'created_at': self.created_at.isoformat()
        }
```

在 `app/models/__init__.py` 中导入：
```python
from app.models.new_model import NewModel
```

#### Step 2: 创建数据验证Schema
在 `app/schemas/` 目录下创建：
```python
# app/schemas/new_schema.py
from marshmallow import Schema, fields, validate

class NewModelCreateSchema(Schema):
    name = fields.Str(required=True, validate=validate.Length(min=1, max=100))
```

#### Step 3: 创建业务逻辑Service
在 `app/services/` 目录下创建：
```python
# app/services/new_service.py
from app.models import db, NewModel

class NewService:
    @staticmethod
    def create(name):
        model = NewModel(name=name)
        db.session.add(model)
        db.session.commit()
        return model
```

#### Step 4: 创建API路由
在 `app/routes/` 目录下创建：
```python
# app/routes/new_routes.py
from flask import Blueprint, request
from app.services.new_service import NewService
from app.schemas.new_schema import NewModelCreateSchema
from app.utils import success_response, error_response, login_required

new_bp = Blueprint('new', __name__)

@new_bp.route('', methods=['POST'])
@login_required
def create_new():
    schema = NewModelCreateSchema()
    data = schema.load(request.get_json())
    model = NewService.create(**data)
    return success_response(data=model.to_dict(), code=201)
```

#### Step 5: 注册路由
在 `app/routes/__init__.py` 中：
```python
from app.routes.new_routes import new_bp

def register_blueprints(app):
    # ...其他路由
    app.register_blueprint(new_bp, url_prefix='/api/new')
```

### 2. 数据库迁移

```bash
# 生成迁移文件
flask db migrate -m "描述"

# 执行迁移
flask db upgrade

# 回滚迁移
flask db downgrade
```

### 3. 测试流程

1. 启动服务：`python run.py`
2. 使用 Postman/Apifox 测试接口
3. 或运行测试脚本：`python test_api.py`

## 代码规范

### 1. 命名规范
- **文件名**: 小写+下划线，如 `user_service.py`
- **类名**: 大驼峰，如 `UserService`
- **函数名**: 小写+下划线，如 `get_user_list`
- **变量名**: 小写+下划线，如 `user_id`

### 2. 注释规范
```python
def function_name(param1, param2):
    """
    函数简短描述
    
    Args:
        param1: 参数1说明
        param2: 参数2说明
    
    Returns:
        返回值说明
    
    Raises:
        异常说明
    """
    pass
```

### 3. 错误处理
```python
try:
    # 业务逻辑
    pass
except ValueError as e:
    return error_response(str(e), 400)
except Exception as e:
    return error_response(f'操作失败: {str(e)}', 500)
```

## 常见问题

### 1. 数据库连接失败
**问题**: `Can't connect to MySQL server`

**解决**:
- 检查 MySQL 服务是否启动
- 检查 `.env` 中的数据库配置
- 检查数据库是否已创建

### 2. 导入错误
**问题**: `ModuleNotFoundError`

**解决**:
- 确保虚拟环境已激活
- 重新安装依赖：`pip install -r requirements.txt`

### 3. JWT认证失败
**问题**: `Token has expired`

**解决**:
- 重新登录获取新token
- 检查系统时间是否正确

### 4. CORS跨域错误
**问题**: 前端请求被拦截

**解决**:
- 检查 `config.py` 中的 `CORS_ORIGINS`
- 确保前端地址已添加到允许列表

## 与前端对接

### 1. API基础URL
前端需要配置：
```typescript
const baseURL = 'http://localhost:5000/api'
```

### 2. 认证流程
```typescript
// 登录
const response = await axios.post('/auth/login', {
  username: 'xxx',
  password: 'xxx'
})

const token = response.data.data.access_token

// 后续请求携带token
axios.defaults.headers.common['Authorization'] = `Bearer ${token}`
```

### 3. 错误处理
```typescript
axios.interceptors.response.use(
  response => response,
  error => {
    if (error.response.status === 401) {
      // 跳转到登录页
    }
    return Promise.reject(error)
  }
)
```

## 与AI模块对接

AI模块需要调用的接口：

### 1. 提交分析结果
```python
POST /api/ai/analysis/results
Content-Type: application/json

{
  "mission_id": 1,
  "video_id": 1,
  "target_type": "行人",
  "occurred_time": "2024-01-15T09:30:00",
  "bounding_box": {"x1": 0.1, "y1": 0.2, "x2": 0.3, "y2": 0.4},
  "confidence": 0.95
}
```

### 2. 创建告警
```python
POST /api/alerts
Content-Type: application/json

{
  "title": "检测到交通事故",
  "event_type": "traffic_accident",
  "severity": "high",
  "road_section": "G4高速K10+200",
  "occurred_time": "2024-01-15T09:30:00",
  "video_id": 1,
  "mission_id": 1
}
```

## 性能优化建议

1. **数据库查询优化**
   - 使用索引
   - 避免N+1查询
   - 使用分页

2. **缓存策略**
   - 使用Redis缓存热点数据
   - 缓存查询结果

3. **异步处理**
   - 使用Celery处理耗时任务
   - 使用定时任务处理后台作业

## 部署指南

详见 `DEPLOYMENT_GUIDE.md` 文件。

## 文档索引

- **README.md**: 项目说明和API文档
- **INSTALL.md**: 详细安装指南
- **PROJECT_STRUCTURE.md**: 项目结构说明
- **DEPLOYMENT_GUIDE.md**: 部署指南
- **开发指南.md**: 本文件

## 联系与支持

如有问题，请联系项目组成员或提交Issue。

祝开发顺利！

